# AGENTS

Agent guide for `@aliou/pi-xcode`.

## Purpose

`pi-xcode` gives Pi a reliable, tool-first interface for Xcode workflows.

Core tools:
- `xcode_project`
- `xcode_build`
- `xcode_simulator`
- `xcode_ui`

Entry point: `src/index.ts`.

## Code map

- `src/index.ts` - registers tools, hooks, `/xcode:settings`, and `/xcode:setup`
- `src/tools/` - tool implementations (actions + routing)
- `src/hooks/` - `guardrails` and `system-prompt` hooks
- `src/commands/settings.ts` - `/xcode:settings` command
- `src/commands/setup.ts` - `/xcode:setup` command (UI runner configuration)
- `src/commands/create-harness.ts` - `/xcode:create-harness` command (scaffold automation harness)
- `src/config.ts` - extension settings via `@aliou/pi-utils-settings`
- `src/guidance.ts` - system prompt guidance text injected by `system-prompt` hook
- `src/libs/` - low-level wrappers: axorcist, osascript, plist, screencapture, simctl, swift-runner, xcodebuild, xcresulttool
- `src/utils/` - shared exec/parsing/error helpers
- `src/utils/backends/` - UI backend implementations (axorcist, runner, shared) and types
- `src/utils/ui-backend.ts` - backend dispatcher (routes actions to axorcist/runner/shared)
- `src/components/` - tool renderers (`XcodeToolCall`, `XcodeToolResult`, render helpers)
- `skills/pi-xcode/` - bundled skill with references for UI test harness and accessibility
- `fixtures/ios-app/` - e2e test iOS app (XcodeGen, UITest harness with automation bridge, runner script)
- `fixtures/macos-app/` - e2e test macOS app (XcodeGen, accessibility-annotated views)
- `flake.nix` - dev shell with nodejs, pnpm, xcodegen, xcodeWrapper

## Settings

Commands:
- `/xcode:settings` - configure all extension settings
- `/xcode:setup` - configure UI runner command (interactive or inline)

Settings keys:
- `systemPromptGuidance` (default: `true`)
- `guardrailsEnabled` (default: `false`)
- `uiRunnerCommand` (default: `null`) - command for interactive `xcode_ui` actions

Guardrails must stay optional and disabled by default unless explicitly changed.

## Engineering rules

1. Keep the 4-tool architecture and boundaries.
2. Keep simulator-first scope unless explicitly asked otherwise.
3. Default UI backend is `xcuitest`; `idb` and `axorcist` (macOS native) are optional.
4. Prefer structured tool results (`content` + `details`) over unstructured text.
5. Keep `xcode:settings` command and settings IDs stable unless migration is intentional.
6. If dependencies change, update lockfile and pass lockfile check.
7. Fixture app `.xcodeproj` files must not be committed. They are generated by XcodeGen.

## Validation

These commands assume you are inside the Nix dev shell (`nix develop` or `direnv allow`).

Run before commit:

```bash
pnpm run lint
pnpm run typecheck
pnpm run check:lockfile
```

Or run all checks:

```bash
pnpm run check
pnpm run check:lockfile
```

## Fixture apps

`fixtures/ios-app/` and `fixtures/macos-app/` are XcodeGen-based test apps for e2e testing of the extension tools.

- `.xcodeproj` files are gitignored; generate with `xcodegen generate` inside each fixture directory.
- The iOS app has a UITest target with an automation bridge harness (same pattern as pi-apps).
- The macOS app is for axorcist backend testing.

## Commit hygiene

- Stage only relevant files.
- Do not commit local artifacts (`.pi/`, temp captures, generated test artifacts).
- Use concise Conventional Commit style messages.
